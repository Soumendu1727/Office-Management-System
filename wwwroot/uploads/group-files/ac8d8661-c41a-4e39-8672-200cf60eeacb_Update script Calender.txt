-- Batch 1: Alter the Stored Procedure
ALTER PROCEDURE [dbo].[sp_Production_CalendarInfo2_NEW]
AS
BEGIN
    SET NOCOUNT ON;

    -- 1. Set up the date range and calendar table (No changes here)
    DECLARE @StartingDay DATETIME = DATEADD(wk, DATEDIFF(wk, 0, GETDATE()), -22);
    DECLARE @EndingDay DATETIME = DATEADD(DAY, 70, @StartingDay);

    IF OBJECT_ID('tempdb..#Days') IS NOT NULL DROP TABLE #Days;
    CREATE TABLE #Days (
        Seq INT PRIMARY KEY,
        DaysToTrack DATE,
        ShiftID INT,
        ShortName VARCHAR(10)
    );

    INSERT INTO #Days (Seq, DaysToTrack, ShiftID, ShortName)
    SELECT 
        ROW_NUMBER() OVER (ORDER BY d.[Date], s.ShiftID), 
        d.[Date], 
        s.ShiftID, 
        s.ShortName
    FROM dbo.GenerateCalendar(@StartingDay, DATEDIFF(DAY, @StartingDay, @EndingDay)) d
    CROSS JOIN (VALUES (1, 'AM'), (2, 'PM')) AS s(ShiftID, ShortName);

    -- 2. Materialize source data with explicit table definitions

    -- MODIFICATION: Explicitly CREATE TABLE for #temp_Production
    IF OBJECT_ID('tempdb..#temp_Production') IS NOT NULL DROP TABLE #temp_Production;
    CREATE TABLE #temp_Production (
        PRODORDERNBR VARCHAR(50),
        PRODITEMNBR VARCHAR(50),
        PRODDATE DATE,
        ShiftID INT,
        ShortName VARCHAR(10),
        PRODALLOCATIONCASES DECIMAL(18,4)
    );

    INSERT INTO #temp_Production (PRODORDERNBR, PRODITEMNBR, PRODDATE, ShiftID, ShortName, PRODALLOCATIONCASES)
    SELECT PRODORDERNBR, PRODITEMNBR, PRODDATE, ShiftID, ShortName, PRODALLOCATIONCASES
    FROM view_Production
    WHERE PRODTYPEID = 1 AND PRODALLOCATIONTYPEID = 1
      AND PRODDATE BETWEEN @StartingDay AND @EndingDay;
    CREATE CLUSTERED INDEX IX_Prod ON #temp_Production(PRODDATE, ShiftID, PRODORDERNBR, PRODITEMNBR);

    -- MODIFICATION: Explicitly CREATE TABLE for #temp_mixed to fix index size warning
    IF OBJECT_ID('tempdb..#temp_mixed') IS NOT NULL DROP TABLE #temp_mixed;
    CREATE TABLE #temp_mixed (
        DATEALLOTTED DATE,
        ORDERNBR VARCHAR(50),
        ITEMNBR VARCHAR(50),
        SHIFTALLOTTED INT,
        MIXES DECIMAL(18,4),
        MIXES_SCANNED DECIMAL(18,4),
        RACKS DECIMAL(18,4),
        RACKS_SCANNED DECIMAL(18,4),
        PALLETS_REMAIN DECIMAL(18,4)
    );
    
    INSERT INTO #temp_mixed (DATEALLOTTED, ORDERNBR, ITEMNBR, SHIFTALLOTTED, MIXES, MIXES_SCANNED, RACKS, RACKS_SCANNED, PALLETS_REMAIN)
    SELECT DATEALLOTTED, ORDERNBR, ITEMNBR, SHIFTALLOTTED, MIXES, MIXES_SCANNED, RACKS, RACKS_SCANNED, PALLETS_REMAIN
    FROM view_MixDetail;
	CREATE CLUSTERED INDEX IX_Mix ON #temp_mixed(DATEALLOTTED, SHIFTALLOTTED, ORDERNBR, ITEMNBR);

    -- MODIFICATION: Explicitly CREATE TABLE for #temp_Allocations
    IF OBJECT_ID('tempdb..#temp_Allocations') IS NOT NULL DROP TABLE #temp_Allocations;
    CREATE TABLE #temp_Allocations(
        IAORDERNBR VARCHAR(50),
        TRITEMNBR VARCHAR(50),
        CASESALLOCATED DECIMAL(18,4)
    );

    INSERT INTO #temp_Allocations(IAORDERNBR, TRITEMNBR, CASESALLOCATED)
    SELECT alo.IAORDERNBR, tr.TRITEMNBR, SUM(ISNULL(alo.IACASESALLOCATED, 0)) AS CASESALLOCATED
    FROM ITEMTRANSACTION tr
    JOIN ITEMALLOCATION alo ON alo.IATRANSID = tr.TRID
    GROUP BY alo.IAORDERNBR, tr.TRITEMNBR;
    CREATE CLUSTERED INDEX IX_Allo ON #temp_Allocations(IAORDERNBR, TRITEMNBR);

	-- 3. Aggregate all component parts into a single temp table
	IF OBJECT_ID('tempdb..#MetricsComponents') IS NOT NULL DROP TABLE #MetricsComponents;
	
    -- MODIFICATION: Best practice to also define this table explicitly
    CREATE TABLE #MetricsComponents (
        PRODDATE DATE,
        ShiftID INT,
        SumProdAllocationCases DECIMAL(18,4),
        SumCasesOrdered DECIMAL(18,4),
        SumCasesAllocated DECIMAL(18,4),
        SumMixesPlanned DECIMAL(18,4),
        SumMixesScanned DECIMAL(18,4),
        SumRacksPlanned DECIMAL(18,4),
        SumRacksScanned DECIMAL(18,4),
        SumPalletsRemain DECIMAL(18,4),
        SumCheeseRacksPlanned DECIMAL(18,4),
        SumCheeseRacksScanned DECIMAL(18,4),
        SumVarCasesOrdered DECIMAL(18,4),
        SumSeedRacksPlanned DECIMAL(18,4),
        SumSeedRacksScanned DECIMAL(18,4),
        SumColorRacksPlanned DECIMAL(18,4),
        SumColorRacksScanned DECIMAL(18,4),
        SumSmallRacksPlanned DECIMAL(18,4),
        SumSmallRacksScanned DECIMAL(18,4),
        SumIWCases DECIMAL(18,4),
        SumExtraLaborCases DECIMAL(18,4)
    );

    INSERT INTO #MetricsComponents
	SELECT
		vp.PRODDATE,
		vp.ShiftID,
		SUM(ISNULL(vp.PRODALLOCATIONCASES, 0)),
		SUM(ISNULL(ld.CASESORDERED, 0)),
		SUM(ISNULL(allo.CASESALLOCATED, 0)),
		SUM(ISNULL(vmd.MIXES, 0)),
		SUM(ISNULL(vmd.MIXES_SCANNED, 0)),
		SUM(ISNULL(vmd.RACKS, 0)),
		SUM(ISNULL(vmd.RACKS_SCANNED, 0)),
		SUM(ISNULL(vmd.PALLETS_REMAIN, 0)),
		SUM(CASE WHEN im.ITEMCHEESE = 1 THEN ISNULL(vmd.RACKS, 0) ELSE 0 END),
		SUM(CASE WHEN im.ITEMCHEESE = 1 THEN ISNULL(vmd.RACKS_SCANNED, 0) ELSE 0 END),
        SUM(CASE WHEN im.ItemVariety = 1 THEN ISNULL(ld.CASESORDERED, 0) ELSE 0 END),
		SUM(CASE WHEN im.ITEMTOPPING NOT IN ('None','Natural Asiago - Cerrado','Asiago - Cerrado','Natural Asiago - Abierto','Natural Jalapeno Cheddar - Abierto','Asiago','Asiago - Closed','Asiago - Open','Asiago - Abierto','Natural Cheddar - Abierto') THEN ISNULL(vmd.RACKS, 0) ELSE 0 END),
		SUM(CASE WHEN im.ITEMTOPPING NOT IN ('None','Natural Asiago - Cerrado','Asiago - Cerrado','Natural Asiago - Abierto','Natural Jalapeno Cheddar - Abierto','Asiago','Asiago - Closed','Asiago - Open','Asiago - Abierto','Natural Cheddar - Abierto') THEN ISNULL(vmd.RACKS_SCANNED, 0) ELSE 0 END),
		SUM(CASE WHEN ld.ITEMDOUGHTYPE IN ('Blueberry', 'Nat. Blueberry', 'Nat. C-Raisin', 'Very Berry', 'Rainbow', 'Nat. Choc Chip', 'Nat. Pumpernickel', 'Green', 'Nat. Marble', 'Cranberry', 'Christmas', 'Pink', 'Buffalo Bills') THEN ISNULL(vmd.RACKS, 0) ELSE 0 END),
		SUM(CASE WHEN ld.ITEMDOUGHTYPE IN ('Blueberry', 'Nat. Blueberry', 'Nat. C-Raisin', 'Very Berry', 'Rainbow', 'Nat. Choc Chip', 'Nat. Pumpernickel', 'Green', 'Nat. Marble', 'Cranberry', 'Christmas', 'Pink', 'Buffalo Bills') THEN ISNULL(vmd.RACKS_SCANNED, 0) ELSE 0 END),
		SUM(CASE WHEN ld.ITEMCUTWEIGHT <= 3.7 THEN ISNULL(vmd.RACKS, 0) ELSE 0 END),
		SUM(CASE WHEN ld.ITEMCUTWEIGHT <= 3.7 THEN ISNULL(vmd.RACKS_SCANNED, 0) ELSE 0 END),
		SUM(CASE WHEN LOWER(ISNULL(ld.BagType,'')) = 'iw clear' THEN ISNULL(ld.CASESORDERED,0) ELSE 0 END),
		SUM(CASE WHEN ISNULL(ld.ExtraLaborforCaseLabel,'') = 'T' THEN ISNULL(ld.CASESORDERED,0) ELSE 0 END)
	FROM #temp_Production AS vp
	JOIN LIVEDOUGH AS ld ON ld.ORDERNBR = vp.PRODORDERNBR AND LEFT(ld.ITEMNBR, 50) COLLATE DATABASE_DEFAULT = vp.PRODITEMNBR COLLATE DATABASE_DEFAULT
	LEFT JOIN #temp_mixed AS vmd ON vmd.ORDERNBR = vp.PRODORDERNBR AND LEFT(vmd.ITEMNBR, 50) COLLATE DATABASE_DEFAULT = vp.PRODITEMNBR COLLATE DATABASE_DEFAULT AND vmd.SHIFTALLOTTED = vp.ShiftID AND vmd.DATEALLOTTED = vp.PRODDATE
	LEFT JOIN #temp_Allocations AS allo ON allo.IAORDERNBR = ld.ORDERNBR AND allo.TRITEMNBR COLLATE DATABASE_DEFAULT = LEFT(ld.ITEMNBR, 50) COLLATE DATABASE_DEFAULT
	LEFT JOIN ITEMMASTER AS im ON im.ITEMNBR COLLATE DATABASE_DEFAULT = vp.PRODITEMNBR COLLATE DATABASE_DEFAULT
	WHERE ld.CASESORDERED > 0 AND ld.ItemNbr COLLATE DATABASE_DEFAULT NOT IN (SELECT ITEMNBR COLLATE DATABASE_DEFAULT FROM ITEMMASTER WHERE ALLOWEDCOPACKED = 0)
	GROUP BY vp.PRODDATE, vp.ShiftID;

	CREATE CLUSTERED INDEX IX_Agg ON #MetricsComponents(PRODDATE, ShiftID);

    -- 4. Final SELECT applying the correct CASE logic to the aggregated components
    SELECT TOP 140
        d.Seq,
        MIXDAYS = CONVERT(VARCHAR, d.DaysToTrack, 101),
        d.ShiftID,
        d.ShortName,
        DISPLAYDAYOFWEEK = dbo.getDayOfWeek(d.DaysToTrack),
        MIXDAYOFWEEK = CASE WHEN dbo.getDayOfWeek(d.DaysToTrack) = LAG(dbo.getDayOfWeek(d.DaysToTrack), 1, '') OVER (ORDER BY d.Seq) THEN '' ELSE dbo.getDayOfWeek(d.DaysToTrack) END,
        MIXDAYSABBRV = FORMAT(d.DaysToTrack, 'M/d'),
        CURRENTDAYYN = CASE WHEN d.DaysToTrack = CONVERT(DATE, GETDATE()) THEN 'Y' ELSE 'N' END,
		TOTALMIXCASES   = ISNULL(m.SumProdAllocationCases, 0) - ISNULL(m.SumCasesAllocated, 0),
		CASESORDERED    = ISNULL(m.SumCasesOrdered, 0),
		CASESALLOCATED  = ISNULL(m.SumCasesAllocated, 0),
		CASESREMAIN     = ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0),
		ALLOPRCNT       = CONVERT(INT, ROUND(ISNULL(m.SumCasesAllocated, 0) * 100.0 / NULLIF(ISNULL(m.SumCasesOrdered, 0), 0), 0)),
		ALLOPRGRS       = REPLICATE('|', CONVERT(INT, ROUND(ISNULL(m.SumCasesAllocated, 0) * 100.0 / NULLIF(NULLIF(m.SumProdAllocationCases,0), 0), 0)) / 10) + ' ' 
					      + CONVERT(VARCHAR, CONVERT(INT, ROUND(ISNULL(m.SumCasesAllocated, 0) * 100.0 / NULLIF(NULLIF(m.SumProdAllocationCases,0), 0), 0))) + ' %',
		PALLETS         = CONVERT(INT, ISNULL(m.SumPalletsRemain, 0)),
		TOTALMIXES = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0) > 0 THEN ISNULL(m.SumMixesPlanned, 0) - ISNULL(m.SumMixesScanned, 0) ELSE 0 END),
		TOTALRACKS = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0) > 0 THEN ISNULL(m.SumRacksPlanned, 0) - ISNULL(m.SumRacksScanned, 0) ELSE 0 END),
		CHEESERACKS = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0) > 0 THEN ISNULL(m.SumCheeseRacksPlanned, 0) - ISNULL(m.SumCheeseRacksScanned, 0) ELSE 0 END),
		VARRACKS = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumVarCasesOrdered, 0) > 0 THEN ISNULL(m.SumVarCasesOrdered, 0) ELSE 0 END),
		SEEDRACKS = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0) > 0 THEN ISNULL(m.SumSeedRacksPlanned, 0) - ISNULL(m.SumSeedRacksScanned, 0) ELSE 0 END),
		COLORRACKS = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0) > 0 THEN ISNULL(m.SumColorRacksPlanned, 0) - ISNULL(m.SumColorRacksScanned, 0) ELSE 0 END),
		SMALLRACKS = CONVERT(DECIMAL(9,2), CASE WHEN ISNULL(m.SumCasesOrdered, 0) - ISNULL(m.SumCasesAllocated, 0) > 0 THEN ISNULL(m.SumSmallRacksPlanned, 0) - ISNULL(m.SumSmallRacksScanned, 0) ELSE 0 END),
		TotalIWCases = CONVERT(DECIMAL(9,2), ISNULL(m.SumIWCases, 0)),
		ExtraLaborCases = CONVERT(DECIMAL(9,2), ISNULL(m.SumExtraLaborCases, 0))
    FROM #Days AS d
    LEFT JOIN #MetricsComponents AS m ON m.PRODDATE = d.DaysToTrack AND m.ShiftID = d.ShiftID
    ORDER BY d.Seq;

END
GO

-- Batch 2: Execute the Stored Procedure
EXEC dbo.sp_Production_CalendarInfo2_NEW;